---
title: "Public Policy 760 Final Project"
author: "Theodore Landsman"
date: "12/2/2020"
output: html_document
---


### Data Import

```{r, warning = FALSE, message=FALSE }
library(tidyverse)
library(readxl)
library(smacof)
library(ggplot2)

wyoming <- read_csv("~/Documents/Wyoming data import.csv")
AlaskaCVR <- read_excel("~/Documents/AlaskaCVR.xlsx", na = "under")

names<-colnames(wyoming)
names[6:10]<- c(1,2,3,4,5)
colnames(wyoming) <- names
wyoming_l <- wyoming %>%
  select(BallotID, `1` ,`2` ,`3` ,`4`, `5` ) %>%
  pivot_longer(-BallotID, names_to = 'rank', values_to = "candidate") %>%
  filter(!candidate %in% c('under','over')) %>%
  pivot_wider(names_from = candidate, values_from = rank, values_fn = first)
names<-colnames(AlaskaCVR)
names[7:11]<- c(1,2,3,4,5)
colnames(AlaskaCVR) <- names
AlaskaCVR$BallotID <- paste0(AlaskaCVR$`Tabulator Id`, AlaskaCVR$`Batch Id`, AlaskaCVR$`Record Id`)
alaska_l <- AlaskaCVR %>% 
  select(`BallotID`, `1` ,`2` ,`3` ,`4`, `5` ) %>%
  pivot_longer(-BallotID, names_to = 'rank', values_to = "candidate") %>%
  filter(!candidate %in% c('under','over', NA)) %>%
  pivot_wider(names_from = candidate, values_from = rank, values_fn = first)

# To do: Losing observations between wyoming and wyoming_l, why? 
```

### Data Preprocessing
```{r, warning = FALSE}
w_matrix <- wyoming_l[,2:10]
a_matrix <- alaska_l[,2:10]
# Impute missing values
# Current Implementation 
w_mat <- w_matrix %>%
    mutate_all(~replace(., is.na(.), 6)) %>% 
    mapply(FUN=as.numeric)
principle_components <- w_mat%>%prcomp()
w_pca <-bind_cols(wyoming_l,as_tibble(principle_components$x))

a_mat <- a_matrix %>%
    mutate_all(~replace(., is.na(.), 6)) %>%
    mapply(FUN=as.numeric)
principle_components <- a_mat%>%prcomp()
a_pca <-bind_cols(alaska_l,as_tibble(principle_components$x))
```

### Cluster Analysis: Wyoming
```{r, warning=FALSE}
w_cluster<-w_pca
library(broom)
# predict four clusters
w_kmeans <-kmeans(w_mat,centers = 4,# number of clusters
                  nstart = 100)# number of random starts

w_cluster$cluster<-w_kmeans$cluster

l_pca<-left_join(w_cluster, wyoming, by = 'BallotID' )
l_pca%>%
  group_by(cluster, `1.y`) %>%
  summarize(count=n()) %>%
  arrange(desc(count)) %>%
  spread(cluster,count)

## Problem, because long form files have different length vs standard files, much harder to merge. 
```

It appears that Biden supports (1) are overwhelmingly in cluster 3, while Sanders supporters are largely in Cluster 2. Cluster 4 seems to be voters who liked both Warren but also Biden and Sanders. Cluster 1 looks to be dominated by Biden supporters who also liked some of the more eccentric also-rans like Bloomberg and Steyer. 

```{r}
ggplot(data = w_cluster) +
  geom_point(aes(x = PC1, y =PC2, color = factor(cluster)),alpha = .4) + 
  theme_minimal()
```

## Clustering Alaska 

```{r, warning=FALSE}
a_cluster<-a_pca
library(broom)
# predict four clusters
a_kmeans <-kmeans(a_mat,centers = 4,# number of clusters
                  nstart = 100)# number of random starts

a_cluster$cluster<-a_kmeans$cluster

l_pca<-left_join(a_cluster, AlaskaCVR, by = "BallotID" )
l_pca%>%
  group_by(cluster, `1.y`) %>%
  summarize(count=n()) %>%
  arrange(desc(count)) %>%
  spread(cluster,count)
```

It appears that Biden supports (1) are overwhelmingly in cluster 3, while Sanders supporters are largely in Cluster 2. Cluster 4 seems to be voters who liked both Warren but also Biden and Sanders. Cluster 1 looks to be dominated by Biden supporters who also liked some of the more eccentric also-rans like Bloomberg and Steyer. 

```{r}
ggplot(data = a_cluster) +
  geom_point(aes(x = PC1, y =PC2, color = factor(cluster)),alpha = .4) + 
  theme_minimal()
```

Are these clouds simmilar? Unclear. 


## Both
```{r}
alaska_l$state<- 'alaska'
wyoming_l$state<- 'wyoming'
b_l<- rbind(alaska_l,wyoming_l)
b_matrix <- b_l[,2:10]

b_mat <- b_matrix %>%
    mutate_all(~replace(., is.na(.), 6)) %>%
    mapply(FUN=as.numeric)
principle_components_b <- b_mat%>%prcomp()
b_pca <-bind_cols(b_l,as_tibble(principle_components_b$x))
```

```{r}
ggplot(data = b_pca) +
  geom_point(aes(x = PC1, y =PC2, color = state), alpha = .4) + 
  theme_minimal()
ggplot(data = b_pca) +
  geom_density(aes(x = PC1, fill = state),alpha = .4) + 
  theme_minimal()
```

Alaska was a much better state for Sanders then Wyoming, but Sanders still lost, suggests that the middle peak in this chart is Biden-Sanders + Sanders-Biden, and that the left peak is Biden only. 

### Clustering Both
```{r}
b_cluster<-b_pca
# predict four clusters
b_kmeans <-kmeans(b_mat,centers = 4,# number of clusters
                  nstart = 100)# number of random starts

b_cluster$cluster<-b_kmeans$cluster
ggplot(data = b_cluster) +
  geom_point(aes(x = PC1, y =PC2, color = factor(cluster)),alpha = .4) + 
  theme_minimal()
ggplot(data = b_cluster) +
  geom_density(aes(x = PC1, fill = factor(cluster)),alpha = .4) + 
  theme_minimal()
```

Pretty clear that Cluster 2 is the Biden only cluster, 3 might be Biden-Sanders,  1 Sanders-Biden, 4 Sanders-Warren?

```{r}
## This takes way too long, maybe a project for AWS!
library(factoextra)
#fviz_nbclust(w_mat, FUN = kmeans, method = "wss")
# fviz_nbclust(pca_data, FUN = kmeans, method = "gap_stat") This one crashes because it runs out of memory
#fviz_nbclust(w_mat, FUN = kmeans, method = "silhouette")
```
